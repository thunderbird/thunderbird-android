<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Legacy Module Integration - Thunderbird for Android - Developer Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Developer Documentation for the Thunderbird for Android project.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../assets/additional/css/last-changed.css">
        <link rel="stylesheet" href="../assets/additional/css/navigation.css">
        <link rel="stylesheet" href="../assets/additional/css/pagetoc.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="dark">Dark</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Thunderbird for Android - Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/thunderbird/thunderbird-android" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/thunderbird/thunderbird-android/edit/main/./architecture/legacy-module-integration.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="-legacy-module-integration"><a class="header" href="#-legacy-module-integration">üîô Legacy Module Integration</a></h1>
<p>This document outlines how existing legacy code is integrated into the new modular architecture of the application and
the strategy for its migration. The core principle is to isolate legacy code and provide a controlled way for
newer modules to interact with legacy functionality without becoming directly dependent on it.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>This document should be read in conjunction with <a href="module-structure.html">Module Structure</a> and <a href="module-organization.html">Module Organization</a> to get a complete understanding of the modular architecture.</p>
</div>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The Thunderbird for Android project is transitioning from a monolithic architecture to a modular one. During this
transition, we need to maintain compatibility with existing legacy code while gradually migrating to the new
architecture. The <code>legacy:*</code>, <code>mail:*</code>, and <code>backend:*</code> modules contain functionality that is still essential for the
project but does not yet adhere to the new modular architecture. These modules are integrated into the new architecture
through the <code>:app-common</code> module, which acts as a bridge or adapter to provide access to legacy functionality without
directly depending on it.</p>
<p>The key components in this integration strategy are:</p>
<ol>
<li><strong>Legacy Modules</strong>: <code>legacy:*</code>, <code>mail:*</code>, and <code>backend:*</code> modules containing existing functionality</li>
<li><strong>Interfaces</strong>: Well-defined interfaces in <code>feature:*:api</code> and <code>core:*</code> modules</li>
<li><strong>App Common Bridge</strong>: The <code>:app-common</code> module that implements these interfaces and delegates to legacy code</li>
<li><strong>Dependency Injection</strong>: Configuration that provides the appropriate implementations to modules</li>
</ol>
<h2 id="integration-approach-the-app-common-bridge"><a class="header" href="#integration-approach-the-app-common-bridge">Integration Approach ‚Äú<em>The App Common Bridge</em>‚Äù</a></h2>
<p>Newer application modules (such as features or core components) depend on well-defined <strong>Interfaces</strong>
(e.g., those found in <code>feature:*:api</code> modules). Typically, a feature will provide its own modern <strong>Implementation</strong>
(e.g., <code>:feature:mail:impl</code>) for its API.</p>
<p>However, to manage dependencies on code still within <code>legacy:*</code>, <code>mail:*</code>, and <code>backend:*</code> modules and prevent it
from spreading, we use <code>app-common</code> as <strong>bridge</strong> or <strong>adapter</strong> to provide an alternative implementation for these. In
this role, <code>app-common</code> is responsible for:</p>
<ol>
<li><strong>Implementing interfaces</strong>: <code>app-common</code> provides concrete implementations for interfaces that newer modules define.</li>
<li><strong>Delegating to legacy code</strong>: Internally, these <code>app-common</code> implementations will delegate calls, adapt data, and manage interactions with the underlying <code>legacy:*</code>, <code>mail:*</code>, and <code>backend:*</code> modules.</li>
<li><strong>Containing glue code</strong>: All logic required to connect the modern interfaces with the legacy systems is encapsulated within <code>app-common</code>.</li>
</ol>
<p>This approach ensures that:</p>
<ul>
<li>Newer modules are decoupled from legacy implementations: They only interact with the defined interfaces, regardless of whether the implementation is the modern feature <code>impl</code> or the <code>app-common</code> bridge.</li>
<li>Legacy code is isolated.</li>
<li>A clear path for refactoring is maintained: Initially, the application might be configured to use the <code>app-common</code> bridge. As new, native implementations in feature modules (e.g., <code>:feature:mail:impl</code>) mature, the dependency injection can be switched to use them, often without changes to the modules consuming the interface.</li>
</ul>
<h3 id="bridge-pattern-flow"><a class="header" href="#bridge-pattern-flow">Bridge Pattern Flow</a></h3>
<p>The typical flow is:</p>
<ol>
<li><strong>Interfaces</strong>: Interfaces are defined, usually within the <code>api</code> module of a feature (e.g., <code>:feature:mail:api</code>) or a core module. These interfaces represent the contract for a piece of functionality.</li>
<li><strong>New Module Dependency</strong>: Newer modules (e.g., <code>:feature:somefeature:impl</code> or other parts of <code>:app-common</code>) depend on these defined interfaces, to avoid dependency on concrete legacy classes.</li>
<li><strong>Implementation</strong>: The <code>:app-common</code> module provides concrete implementations for these interfaces.</li>
<li><strong>Delegation to Legacy</strong>: Internally, these implementations within <code>:app-common</code> delegate the actual work to the code residing in the legacy modules (e.g., <code>legacy:*</code>, <code>mail:*</code>, <code>backend:*</code>).</li>
<li><strong>Dependency Injection</strong>: The application‚Äôs dependency injection framework is configured to provide instances of these <code>:app-common</code> bridge implementations when a newer module requests an implementation of the interface.</li>
</ol>
<p>This pattern ensures that newer modules remain decoupled from the specifics of legacy code.</p>
<p>The following diagram illustrates this pattern, showing how both a feature‚Äôs own implementation and <code>app-common</code> can relate to the interfaces, with <code>app-common</code> specifically bridging to legacy systems:</p>
<pre class="mermaid">graph TB
    subgraph FEATURE[Feature Modules]
        direction TB
        INTERFACES[&quot;`**Interfaces**&lt;br&gt; (e.g., :feature:mail:api)`&quot;]
        IMPLEMENTATIONS[&quot;`**Implementations**&lt;br&gt; (e.g., :feature:mail:impl)`&quot;]
        OTHER_MODULES[&quot;`**Other Modules**&lt;br&gt;(depend on Interfaces)`&quot;]
    end

    subgraph COMMON[App Common Module]
        direction TB
        COMMON_APP[&quot;`**:app-common**&lt;br&gt;Integration Code`&quot;]
    end

    subgraph LEGACY[Legacy Modules]
        direction TB
        LEGACY_K9[&quot;`**:legacy**`&quot;]
        LEGACY_MAIL[&quot;`**:mail**`&quot;]
        LEGACY_BACKEND[&quot;`**:backend**`&quot;]
    end

    OTHER_MODULES --&gt; |uses| INTERFACES
    IMPLEMENTATIONS --&gt; |depends on| INTERFACES
    COMMON_APP --&gt; |implements| INTERFACES
    COMMON_APP --&gt; |delegates to / wraps| LEGACY_K9
    COMMON_APP --&gt; |delegates to / wraps| LEGACY_MAIL
    COMMON_APP --&gt; |delegates to / wraps| LEGACY_BACKEND

    classDef common fill:#e6e6e6,stroke:#000000,color:#000000
    classDef common_module fill:#999999,stroke:#000000,color:#000000
    classDef feature fill:#d9ffd9,stroke:#000000,color:#000000
    classDef feature_module fill:#33cc33,stroke:#000000,color:#000000
    classDef legacy fill:#ffe6e6,stroke:#000000,color:#000000
    classDef legacy_module fill:#ff9999,stroke:#000000,color:#000000

    linkStyle default stroke:#999,stroke-width:2px

    class COMMON common
    class COMMON_APP common_module
    class FEATURE feature
    class INTERFACES,IMPLEMENTATIONS,OTHER_MODULES feature_module
    class LEGACY legacy
    class LEGACY_MAIL,LEGACY_BACKEND,LEGACY_K9 legacy_module
</pre>
<h3 id="implementation-techniques"><a class="header" href="#implementation-techniques">Implementation Techniques</a></h3>
<p>Several techniques are used to implement the bridge pattern effectively:</p>
<ol>
<li>
<p><strong>Wrapper Classes</strong>: Creating immutable data classes that wrap legacy data structures, implementing interfaces from the new architecture. These wrappers should not contain conversion methods but should delegate this responsibility to specific mapper classes.</p>
</li>
<li>
<p><strong>Adapter Implementations</strong>: Classes in <code>:app-common</code> that implement interfaces from the new architecture but delegate to legacy code internally.</p>
</li>
<li>
<p><strong>Data Conversion</strong>: Dedicated mapper classes that handle mapping between legacy and new data structures, ensuring clean separation of concerns.</p>
</li>
</ol>
<h4 id="example-account-profile-bridge"><a class="header" href="#example-account-profile-bridge">Example: Account Profile Bridge</a></h4>
<p>A concrete example of this pattern is the account profile bridge, which demonstrates a complete implementation of the bridge pattern across multiple layers:</p>
<ol>
<li><strong>Modern Interfaces</strong>:
<ul>
<li><code>AccountProfileRepository</code> in <code>feature:account:api</code> defines the high-level contract for account profile management</li>
<li><code>AccountProfileLocalDataSource</code> in <code>feature:account:core</code> defines the data access contract</li>
</ul>
</li>
<li><strong>Modern Data Structure</strong>: <code>AccountProfile</code> in <code>feature:account:api</code> is a clean, immutable data class that represents account profile information in the new architecture.</li>
<li><strong>Repository Implementation</strong>: <code>DefaultAccountProfileRepository</code> in <code>feature:account:core</code> implements the <code>AccountProfileRepository</code> interface and depends on <code>AccountProfileLocalDataSource</code>.</li>
<li><strong>Bridge Implementation</strong>: <code>DefaultAccountProfileLocalDataSource</code> in <code>app-common</code> implements the <code>AccountProfileLocalDataSource</code> interface and serves as the bridge to legacy code.</li>
<li><strong>Legacy Access</strong>: The bridge uses <code>DefaultLegacyAccountWrapperManager</code> to access legacy account data:
<ul>
<li><code>LegacyAccountWrapperManager</code> in <code>core:android:account</code> defines the contract for legacy account access</li>
<li><code>LegacyAccountWrapper</code> in <code>core:android:account</code> is an immutable wrapper around the legacy <code>LegacyAccount</code> class</li>
</ul>
</li>
<li><strong>Data Conversion</strong>: The bridge uses a dedicated mapper class to convert between modern <code>AccountProfile</code> objects and legacy account data.</li>
<li><strong>Dependency Injection</strong>: The <code>appCommonAccountModule</code> in <code>app-common</code> registers <code>DefaultAccountProfileLocalDataSource</code> as implementations of the respective interface.</li>
</ol>
<p>This multi-layered approach allows newer modules to interact with legacy account functionality through clean, modern interfaces without directly depending on legacy code. It also demonstrates how bridges can be composed, with higher-level bridges (AccountProfile) building on lower-level bridges (LegacyAccountWrapper).</p>
<h2 id="testing-considerations"><a class="header" href="#testing-considerations">Testing Considerations</a></h2>
<p>Testing bridge implementations requires special attention to ensure both the bridge itself and its integration with legacy code work correctly:</p>
<ol>
<li><strong>Unit Testing Bridge Classes</strong>:
<ul>
<li>Test the bridge implementation in isolation by faking/stubbing the legacy dependencies</li>
<li>Verify that the bridge correctly translates between the new interfaces and legacy code</li>
<li>Focus on testing the conversion logic and error handling</li>
</ul>
</li>
<li><strong>Integration Testing</strong>:
<ul>
<li>Test the bridge with actual legacy code to ensure proper integration</li>
<li>Verify that the bridge correctly handles all edge cases from legacy code</li>
</ul>
</li>
<li><strong>Test Doubles</strong>:
<ul>
<li>Create fake implementations of bridge classes for testing other components</li>
<li>Example: <code>FakeLegacyAccountWrapperManager</code> can be used to test components that depend on <code>LegacyAccountWrapperManager</code></li>
</ul>
</li>
<li><strong>Migration Testing</strong>:
<ul>
<li>When migrating from a legacy bridge to a new implementation, test both implementations with the same test suite</li>
<li>Ensure behavior consistency during the transition</li>
</ul>
</li>
</ol>
<h3 id="testing-examples"><a class="header" href="#testing-examples">Testing Examples</a></h3>
<p>Below are examples of tests for legacy module integration, demonstrating different testing approaches and best practices.</p>
<h4 id="example-1-unit-testing-a-bridge-implementation"><a class="header" href="#example-1-unit-testing-a-bridge-implementation">Example 1: Unit Testing a Bridge Implementation</a></h4>
<p>This example shows how to test a bridge implementation (<code>DefaultAccountProfileLocalDataSource</code>) in isolation by using a fake implementation of the legacy dependency (<code>FakeLegacyAccountWrapperManager</code>):</p>
<pre><code class="language-kotlin">class DefaultAccountProfileLocalDataSourceTest {

    @Test
    fun `getById should return account profile`() = runTest {
        // arrange
        val accountId = AccountIdFactory.create()
        val legacyAccount = createLegacyAccount(accountId)
        val accountProfile = createAccountProfile(accountId)
        val testSubject = createTestSubject(legacyAccount)

        // act &amp; assert
        testSubject.getById(accountId).test {
            assertThat(awaitItem()).isEqualTo(accountProfile)
        }
    }

    @Test
    fun `getById should return null when account is not found`() = runTest {
        // arrange
        val accountId = AccountIdFactory.create()
        val testSubject = createTestSubject(null)

        // act &amp; assert
        testSubject.getById(accountId).test {
            assertThat(awaitItem()).isEqualTo(null)
        }
    }

    @Test
    fun `update should save account profile`() = runTest {
        // arrange
        val accountId = AccountIdFactory.create()
        val legacyAccount = createLegacyAccount(accountId)
        val accountProfile = createAccountProfile(accountId)

        val updatedName = "updatedName"
        val updatedAccountProfile = accountProfile.copy(name = updatedName)

        val testSubject = createTestSubject(legacyAccount)

        // act &amp; assert
        testSubject.getById(accountId).test {
            assertThat(awaitItem()).isEqualTo(accountProfile)

            testSubject.update(updatedAccountProfile)

            assertThat(awaitItem()).isEqualTo(updatedAccountProfile)
        }
    }

    private fun createTestSubject(
        legacyAccount: LegacyAccountWrapper?,
    ): DefaultAccountProfileLocalDataSource {
        return DefaultAccountProfileLocalDataSource(
            accountManager = FakeLegacyAccountWrapperManager(
                initialAccounts = if (legacyAccount != null) {
                    listOf(legacyAccount)
                } else {
                    emptyList()
                },
            ),
            dataMapper = DefaultAccountProfileDataMapper(
                avatarMapper = DefaultAccountAvatarDataMapper(),
            ),
        )
    }
}
</code></pre>
<p>Key points:</p>
<ul>
<li>The test creates a controlled test environment using a fake implementation of the legacy dependency</li>
<li>It tests both success cases and error handling (account not found)</li>
<li>It verifies that the bridge correctly translates between legacy data structures and domain models</li>
<li>The test is structured with clear arrange, act, and assert sections</li>
</ul>
<h4 id="example-2-creating-test-doubles-for-legacy-dependencies"><a class="header" href="#example-2-creating-test-doubles-for-legacy-dependencies">Example 2: Creating Test Doubles for Legacy Dependencies</a></h4>
<p>This example shows how to create a fake implementation of a legacy dependency (<code>FakeLegacyAccountWrapperManager</code>) for testing:</p>
<pre><code class="language-kotlin">internal class FakeLegacyAccountWrapperManager(
    initialAccounts: List&lt;LegacyAccountWrapper&gt; = emptyList(),
) : LegacyAccountWrapperManager {

    private val accountsState = MutableStateFlow(
        initialAccounts,
    )
    private val accounts: StateFlow&lt;List&lt;LegacyAccountWrapper&gt;&gt; = accountsState

    override fun getAll(): Flow&lt;List&lt;LegacyAccountWrapper&gt;&gt; = accounts

    override fun getById(id: AccountId): Flow&lt;LegacyAccountWrapper?&gt; = accounts
        .map { list -&gt;
            list.find { it.id == id }
        }

    override suspend fun update(account: LegacyAccountWrapper) {
        accountsState.update { currentList -&gt;
            currentList.toMutableList().apply {
                removeIf { it.uuid == account.uuid }
                add(account)
            }
        }
    }
}
</code></pre>
<p>Key points:</p>
<ul>
<li>The fake implementation implements the same interface as the real implementation</li>
<li>It provides a simple in-memory implementation for testing</li>
<li>It uses Kotlin Flows to simulate the reactive behavior of the real implementation</li>
<li>It allows for easy setup of test data through the constructor parameter</li>
</ul>
<h4 id="example-3-testing-data-conversion-logic"><a class="header" href="#example-3-testing-data-conversion-logic">Example 3: Testing Data Conversion Logic</a></h4>
<p>This example shows how to test data conversion logic in bridge implementations:</p>
<pre><code class="language-kotlin">class DefaultAccountProfileDataMapperTest {

    @Test
    fun `toDomain should convert ProfileDto to AccountProfile`() {
        // Arrange
        val dto = createProfileDto()
        val expected = createAccountProfile()

        val testSubject = DefaultAccountProfileDataMapper(
            avatarMapper = FakeAccountAvatarDataMapper(
                dto = dto.avatar,
                domain = expected.avatar,
            ),
        )

        // Act
        val result = testSubject.toDomain(dto)

        // Assert
        assertThat(result.id).isEqualTo(expected.id)
        assertThat(result.name).isEqualTo(expected.name)
        assertThat(result.color).isEqualTo(expected.color)
        assertThat(result.avatar).isEqualTo(expected.avatar)
    }

    @Test
    fun `toDto should convert AccountProfile to ProfileDto`() {
        // Arrange
        val domain = createAccountProfile()
        val expected = createProfileDto()

        val testSubject = DefaultAccountProfileDataMapper(
            avatarMapper = FakeAccountAvatarDataMapper(
                dto = expected.avatar,
                domain = domain.avatar,
            ),
        )

        // Act
        val result = testSubject.toDto(domain)

        // Assert
        assertThat(result.id).isEqualTo(expected.id)
        assertThat(result.name).isEqualTo(expected.name)
        assertThat(result.color).isEqualTo(expected.color)
        assertThat(result.avatar).isEqualTo(expected.avatar)
    }
}
</code></pre>
<p>Key points:</p>
<ul>
<li>The test verifies that the mapper correctly converts between legacy data structures (DTOs) and domain models</li>
<li>It tests both directions of the conversion (toDomain and toDto)</li>
<li>It uses a fake implementation of a dependency (FakeAccountAvatarDataMapper) to isolate the test</li>
<li>It verifies that all properties are correctly mapped</li>
</ul>
<h4 id="best-practices-for-testing-legacy-module-integration"><a class="header" href="#best-practices-for-testing-legacy-module-integration">Best Practices for Testing Legacy Module Integration</a></h4>
<ol>
<li><strong>Isolate the Bridge</strong>: Test the bridge implementation in isolation by using fake or mock implementations of legacy dependencies.</li>
<li><strong>Test Both Directions</strong>: For data conversion, test both directions (legacy to domain and domain to legacy).</li>
<li><strong>Cover Edge Cases</strong>: Test edge cases such as null values, empty collections, and error conditions.</li>
<li><strong>Use Clear Test Structure</strong>: Structure tests with clear arrange, act, and assert sections.</li>
<li><strong>Create Reusable Test Fixtures</strong>: Create helper methods for creating test data to make tests more readable and maintainable.</li>
<li><strong>Test Reactive Behavior</strong>: For reactive code (using Flows, LiveData, etc.), use appropriate testing utilities (e.g., Turbine for Flow testing).</li>
<li><strong>Verify Integration</strong>: In addition to unit tests, create integration tests that verify the bridge works correctly with actual legacy code.</li>
<li><strong>Test Migration Path</strong>: When migrating from a legacy bridge to a new implementation, test both implementations with the same test suite to ensure behavior consistency.</li>
</ol>
<h2 id="migration-strategy"><a class="header" href="#migration-strategy">Migration Strategy</a></h2>
<p>The long-term strategy involves gradually migrating functionality out of the legacy modules:</p>
<ol>
<li><strong>Identify Functionality</strong>: Pinpoint specific functionalities within legacy modules that need to be modernized.</li>
<li><strong>Define Interfaces</strong>: Ensure clear interfaces are defined (typically in feature <code>api</code> modules) for this functionality.</li>
<li><strong>Entity Modeling</strong>: Create proper domain entity models that represent the business objects as immutable data classes.</li>
<li><strong>Implement in New Modules</strong>: Re-implement the functionality within new, dedicated feature <code>impl</code> modules or core modules.</li>
<li><strong>Update Bridge (Optional)</strong>: If <code>:app-common</code> was bridging to this specific legacy code, its bridge implementation can be updated or removed.</li>
<li><strong>Switch DI Configuration</strong>: Update the dependency injection to provide the new modern implementation instead of the legacy bridge.</li>
<li><strong>Retire Legacy Code</strong>: Once no longer referenced, the corresponding legacy code can be safely removed.</li>
</ol>
<h3 id="migration-example"><a class="header" href="#migration-example">Migration Example</a></h3>
<p>Using the account profile example, the migration process would look like:</p>
<ol>
<li><strong>Identify</strong>: Account profile functionality in legacy modules needs modernization.</li>
<li><strong>Define Interfaces</strong>:
<ul>
<li><code>AccountProfileRepository</code> interface is defined in <code>feature:account:api</code></li>
<li><code>AccountProfileLocalDataSource</code> interface is defined in <code>feature:account:core</code></li>
</ul>
</li>
<li><strong>Entity Modeling</strong>: Create <code>AccountProfile</code> as an immutable data class in <code>feature:account:api</code>.</li>
<li><strong>Implement</strong>: Create a new implementation of <code>AccountProfileLocalDataSource</code> in a modern module, e.g., <code>feature:account:impl</code>.</li>
<li><strong>Update Bridge</strong>: Update or remove <code>DefaultAccountProfileLocalDataSource</code> in <code>app-common</code>.</li>
<li><strong>Switch DI</strong>: Update <code>appCommonAccountModule</code> to provide the new implementation instead of <code>DefaultAccountProfileLocalDataSource</code>.</li>
<li><strong>Retire</strong>: Once all references to legacy account code are removed, the legacy code and lower-level bridges (<code>LegacyAccountWrapperManager</code>, <code>DefaultLegacyAccountWrapperManager</code>) can be safely deleted.</li>
</ol>
<p>This approach ensures a smooth transition with minimal disruption to the application‚Äôs functionality.</p>
<h2 id="dependency-direction"><a class="header" href="#dependency-direction">Dependency Direction</a></h2>
<p>A strict dependency rule is enforced: <strong>New modules (features, core) must not directly depend on legacy modules.</strong>
The dependency flow is always from newer modules to interfaces, with <code>:app-common</code> providing the implementation.
If <code>:app-common</code> bridges to legacy code, that is an internal detail of <code>:app-common</code>.</p>
<p>The legacy module integration diagram below explains how legacy code is integrated into the new modular architecture:</p>
<pre class="mermaid">graph TB
    subgraph APP[App Modules]
        direction TB
        APP_TB[&quot;`**:app-thunderbird**&lt;br&gt;Thunderbird for Android`&quot;]
        APP_K9[&quot;`**:app-k9mail**&lt;br&gt;K-9 Mail`&quot;]
    end

    subgraph COMMON[App Common Module]
        direction TB
        COMMON_APP[&quot;`**:app-common**&lt;br&gt;Integration Code`&quot;]
    end

    subgraph FEATURE[Feature Modules]
        direction TB
        FEATURE1[Feature 1]
        FEATURE2[Feature 2]
        FEATURE3[Feature from Legacy]
    end

    subgraph CORE[Core Modules]
        direction TB
        CORE1[Core 1]
        CORE2[Core 2]
        CORE3[Core from Legacy]
    end

    subgraph LIBRARY[Library Modules]
        direction TB
        LIB1[Library 1]
        LIB2[Library 2]
    end

    subgraph LEGACY[Legacy Modules]
        direction TB
        LEGACY_CODE[Legacy Code]
    end

    APP_K9 --&gt; |depends on| COMMON_APP
    APP_TB --&gt; |depends on| COMMON_APP
    COMMON_APP --&gt; |integrates| FEATURE1
    COMMON_APP --&gt; |integrates| FEATURE2
    COMMON_APP --&gt; |integrates| FEATURE3
    FEATURE1 --&gt; |uses| CORE1
    FEATURE1 --&gt; |uses| LIB2
    FEATURE2 --&gt; |uses| CORE2
    FEATURE2 --&gt; |uses| CORE3
    COMMON_APP --&gt; |integrates| LEGACY_CODE
    LEGACY_CODE -.-&gt; |migrate to| FEATURE3
    LEGACY_CODE -.-&gt; |migrate to| CORE3

    classDef app fill:#d9e9ff,stroke:#000000,color:#000000
    classDef app_module fill:#4d94ff,stroke:#000000,color:#000000
    classDef common fill:#e6e6e6,stroke:#000000,color:#000000
    classDef common_module fill:#999999,stroke:#000000,color:#000000
    classDef feature fill:#d9ffd9,stroke:#000000,color:#000000
    classDef feature_module fill:#33cc33,stroke:#000000,color:#000000
    classDef core fill:#e6cce6,stroke:#000000,color:#000000
    classDef core_module fill:#cc99cc,stroke:#000000,color:#000000
    classDef library fill:#fff0d0,stroke:#000000,color:#000000
    classDef library_module fill:#ffaa33,stroke:#000000,color:#000000
    classDef legacy fill:#ffe6e6,stroke:#000000,color:#000000
    classDef legacy_module fill:#ff9999,stroke:#000000,color:#000000

    linkStyle default stroke:#999,stroke-width:2px

    class APP app
    class APP_K9,APP_TB app_module
    class COMMON common
    class COMMON_APP common_module
    class FEATURE feature
    class FEATURE1,FEATURE2,FEATURE3 feature_module
    class CORE core
    class CORE1,CORE2,CORE3 core_module
    class LIBRARY library
    class LIB1,LIB2 library_module
    class LEGACY legacy
    class LEGACY_CODE legacy_module
</pre>
<footer id="last-change">Last change: <time datetime="2025-10-01">2025-10-01</time>, commit: <a href="https://github.com/thunderbird/thunderbird-android/commit/9f93f93">9f93f93</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../architecture/user-flows.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../architecture/adr/README.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../architecture/user-flows.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../architecture/adr/README.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../assets/additional/js/mermaid.min.js"></script>
        <script src="../assets/additional/js/mermaid-init.js"></script>
        <script src="../assets/additional/js/navigation.js"></script>
        <script src="../assets/additional/js/pagetoc.js"></script>



    </div>
    </body>
</html>
